<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Ultimate IPTV Player PRO</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
:root{
--bg:#000;
--card:#121212;
--accent:#00E5FF;
--text:#fff;
--fav:#FFD700;
}

*{margin:0;padding:0;box-sizing:border-box;font-family:Segoe UI,Arial,sans-serif;}
body{background:var(--bg);color:var(--text);height:100vh;display:flex;flex-direction:column;overflow:hidden;}

/* PLAYER */
.player-wrap{position:relative;width:100%;aspect-ratio:16/9;background:#000;overflow:hidden;}
video{width:100%;height:100%;object-fit:contain;pointer-events:auto;}
#visualizer{position:absolute;inset:0;display:none;z-index:1;}

/* CONTROLS */
.controls-overlay{
position:absolute;inset:0;background:rgba(0,0,0,0.4);
opacity:0;visibility:hidden;transition:.3s;
display:flex;flex-direction:column;justify-content:flex-end;
z-index:100;
}
.controls-overlay.show{opacity:1;visibility:visible;}

.bottom-bar{
padding:10px 15px;
display:flex;justify-content:space-between;
background:linear-gradient(transparent,rgba(0,0,0,.9));
align-items:center;
}

.bottom-bar .mini-btns i{margin-right:15px;cursor:pointer;font-size:1.3rem;}
.right-side{display:flex;gap:15px;}
.right-side i{font-size:1.3rem;cursor:pointer;}

/* POPUP */
.pop-menu{
position:absolute;background:#111;border-radius:10px;
min-width:150px;display:none;flex-direction:column;z-index:200;
box-shadow:0 5px 15px rgba(0,0,0,.8);
}
.pop-menu button{
background:none;border:none;color:white;padding:12px;text-align:left;cursor:pointer;
}
.pop-menu button:hover{background:var(--accent);color:#000;}

/* INFO BAR */
.info{padding:12px;display:flex;justify-content:space-between;align-items:center;background:#080808;border-bottom:1px solid #222;}
.info #title{font-weight:bold;}
.info #count{background:rgba(0,229,255,0.1);padding:4px 10px;border-radius:5px;}

/* ACTIONS */
.actions{display:flex;padding:12px 0;background:#050505;border-bottom:1px solid #222;}
.actions div{flex:1;text-align:center;color:#aaa;cursor:pointer;position:relative;}
.actions div.active-tab{color:var(--accent);font-weight:bold;}

/* CHANNEL LIST */
.list{flex:1;overflow-y:auto;padding:12px;}
.row{display:flex;align-items:center;gap:12px;background:var(--card);padding:12px;border-radius:10px;margin-bottom:10px;cursor:pointer;}
.row.active{border:1px solid var(--accent);}
.list-logo{width:45px;height:45px;border-radius:8px;object-fit:cover;}
</style>
</head>
<body>

<div class="player-wrap" id="playerArea">
<canvas id="visualizer"></canvas>
<video id="video" playsinline></video>

<div class="pop-menu" id="popMenu"></div>

<div class="controls-overlay" id="controls">
<div class="bottom-bar">
<div class="mini-btns">
<i class="fas fa-play" id="pp" onclick="togglePlay(event)"></i>
<i class="fas fa-redo" onclick="location.reload()"></i>
</div>
<div class="right-side">
<i class="fas fa-sliders-h" onclick="showScalingMenu(event)"></i>
<i class="fas fa-cog" onclick="showQualityMenu(event)"></i>
<i class="fas fa-expand" onclick="toggleFull(event)"></i>
</div>
</div>
</div>
</div>

<div class="info">
<div style="display:flex;align-items:center;gap:12px;">
<img id="currentLogo" class="list-logo" src="https://i.imgur.com/8Qf6Y0L.png">
<div>
<div id="title">Select Channel</div>
<small style="color:var(--accent);font-weight:bold;">LIVE STREAM</small>
</div>
</div>
<div id="count">0 CH</div>
</div>

<div class="actions">
<div class="active-tab" onclick="switchTab('all',this)">All List</div>
<div onclick="switchTab('fav',this)">My List</div>
<div onclick="window.open('https://t.me/bestiptvlive')">Telegram</div>
</div>

<div class="list" id="list"></div>

<script>
const video=document.getElementById("video");
const playerArea=document.getElementById("playerArea");
const popMenu=document.getElementById("popMenu");
const controls=document.getElementById("controls");
const listArea=document.getElementById("list");
const canvas=document.getElementById("visualizer");
const ctx=canvas.getContext("2d");

let hls=new Hls();
let allChannels=[];
let hideTimeout;
let startY,startVal,isLeft;
let audioCtx,analyser,dataArray;

//////////////////// POPUP ////////////////////

function showPopup(e,html){
e.stopPropagation();
popMenu.innerHTML=html;
popMenu.style.display="flex";
requestAnimationFrame(()=>{
const btn=e.currentTarget.getBoundingClientRect();
const wrap=playerArea.getBoundingClientRect();
const menu=popMenu.getBoundingClientRect();

let left=btn.left-wrap.left+(btn.width/2)-(menu.width/2);
let top=btn.top-wrap.top-menu.height-8;

if(left<10) left=10;
if(left+menu.width>playerArea.clientWidth) left=playerArea.clientWidth-menu.width-10;
if(top<10) top=btn.bottom-wrap.top+8;

popMenu.style.left=left+"px";
popMenu.style.top=top+"px";
});
}

document.addEventListener("click",()=>popMenu.style.display="none");

//////////////////// QUALITY ////////////////////
function showQualityMenu(e){
let html=`<button onclick="setQuality(-1)">Auto Quality</button>`;
if(hls.levels){
hls.levels.forEach((l,i)=>{html+=`<button onclick="setQuality(${i})">${l.height||i}p</button>`});
}
showPopup(e,html);
}
function setQuality(i){hls.currentLevel=i;popMenu.style.display="none";}

//////////////////// SCALING ////////////////////
function showScalingMenu(e){
showPopup(e,`
<button onclick="setScaling('contain')">Fit Screen</button>
<button onclick="setScaling('cover')">Zoom to Screen</button>
<button onclick="setScaling('fill')">Stretch</button>
`);
}
function setScaling(type){video.style.objectFit=type;popMenu.style.display="none";}

//////////////////// FULLSCREEN ////////////////////
function toggleFull(e){
if(e)e.stopPropagation();
if(!document.fullscreenElement){
playerArea.requestFullscreen().then(()=>{if(screen.orientation?.lock)screen.orientation.lock("landscape").catch(()=>{});});
video.style.objectFit="cover";
}else{
document.exitFullscreen();
video.style.objectFit="contain";
}
}

//////////////////// SWIPE BRIGHTNESS/VOLUME ////////////////////
playerArea.addEventListener("touchstart",e=>{
if(!document.fullscreenElement) return;
startY=e.touches[0].clientY;
isLeft=e.touches[0].clientX<playerArea.clientWidth/2;
startVal=isLeft?(parseFloat(playerArea.dataset.bright)||1):video.volume;
});
playerArea.addEventListener("touchmove",e=>{
if(!document.fullscreenElement) return;
let delta=(startY-e.touches[0].clientY)/150;
if(isLeft){
let b=Math.min(Math.max(startVal+delta,0.3),1.8);
playerArea.style.filter=`brightness(${b})`;
playerArea.dataset.bright=b;
}else{
let v=Math.min(Math.max(startVal+delta,0),1);
video.volume=v;
}
});

//////////////////// AUDIO VISUALIZER ////////////////////
function initVisualizer(){
if(audioCtx) return;
audioCtx=new(window.AudioContext||window.webkitAudioContext)();
analyser=audioCtx.createAnalyser();
const source=audioCtx.createMediaElementSource(video);
source.connect(analyser);analyser.connect(audioCtx.destination);
analyser.fftSize=128;
dataArray=new Uint8Array(analyser.frequencyBinCount);
draw();
}
function draw(){
requestAnimationFrame(draw);
if(!analyser||canvas.style.display==='none') return;
analyser.getByteFrequencyData(dataArray);
canvas.width=playerArea.clientWidth;
canvas.height=playerArea.clientHeight;
ctx.clearRect(0,0,canvas.width,canvas.height);
let barWidth=(canvas.width/dataArray.length)*2.5;
let x=0;
for(let i=0;i<dataArray.length;i++){
let h=(dataArray[i]/255)*canvas.height;
ctx.fillStyle="rgba(0,229,255,0.7)";
ctx.fillRect(x,(canvas.height-h)/2,barWidth-2,h);
x+=barWidth;
}
}

video.onloadedmetadata=()=>{
canvas.style.display=(video.videoHeight===0)?"block":"none";
if(canvas.style.display==='block') initVisualizer();
};

//////////////////// PLAY ////////////////////
function play(url,name,logo){
if(audioCtx?.state==='suspended') audioCtx.resume();
document.getElementById("title").innerText=name;
document.getElementById("currentLogo").src=logo||"https://i.imgur.com/8Qf6Y0L.png";
if(url.includes(".m3u8")){
hls.destroy();hls=new Hls();hls.loadSource(url);hls.attachMedia(video);
hls.on(Hls.Events.MANIFEST_PARSED,()=>video.play());
}else{video.src=url;video.play();}
document.getElementById("pp").className="fas fa-pause";
}

function togglePlay(e){if(e)e.stopPropagation();video.paused?video.play():video.pause();}

//////////////////// CONTROLS SHOW ////////////////////
let controlTimer;
function showControls(){
controls.classList.add("show");
clearTimeout(controlTimer);
controlTimer=setTimeout(()=>controls.classList.remove("show"),3000);
}
playerArea.addEventListener("click",showControls);
playerArea.addEventListener("touchstart",showControls);

//////////////////// LIST ////////////////////
function render(){
listArea.innerHTML="";
document.getElementById("count").innerText=allChannels.length+" CH";
allChannels.forEach(ch=>{
const d=document.createElement("div");
d.className="row";
d.innerHTML=`<img src="${ch.logo||''}" class="list-logo"><div>${ch.name}</div>`;
d.onclick=()=>play(ch.url,ch.name,ch.logo);
listArea.appendChild(d);
});
}

function switchTab(type,el){
document.querySelectorAll('.actions div').forEach(d=>d.classList.remove('active-tab'));
el.classList.add('active-tab');
render();
}

//////////////////// PLAYLIST ////////////////////
const playlistUrl=new URLSearchParams(location.search).get("playlist");
if(playlistUrl){
fetch(playlistUrl).then(r=>r.text()).then(data=>{
let lines=data.split("\n"),c={};
lines.forEach(l=>{
if(l.startsWith("#EXTINF")){
c.name=l.split(",")[1];
c.logo=l.match(/tvg-logo="([^"]*)"/)?.[1];
}else if(l.startsWith("http")){
c.url=l.trim();allChannels.push({...c});c={};
}
});
render();
if(allChannels[0]) play(allChannels[0].url,allChannels[0].name,allChannels[0].logo);
});
}

window.onresize=()=>{canvas.width=playerArea.clientWidth;canvas.height=playerArea.clientHeight;};
window.dispatchEvent(new Event("resize"));
</script>

</body>
</html>
